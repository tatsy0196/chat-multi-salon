<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Multi-Salons</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #chat-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #messages {
            list-style: none;
            margin: 0;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }
        #messages li {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
        }
        #messages li:last-child {
            border-bottom: none;
        }
        #messages li strong {
            color: #007bff;
        }
        form {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        input,
        select {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div id="chat-container">
    <h1> Chat Multi-Salons</h1>

    <!-- Connexion / Inscription -->
    <div id="auth-section">
        <h2> Connexion</h2>
        <form id="form-login">
            <input id="login-username" placeholder="Nom d'utilisateur" required />
            <input
                  id="login-password"
                    type="password"
                    placeholder="Mot de passe"
                    required
            />
            <button type="submit">Se connecter</button>
        </form>

        <h3>Ou crÃ©ez un compte :</h3>
        <form id="form-register">
            <input
                    id="register-username"
                    placeholder="Nom d'utilisateur"
                    required
            />
            <input
                    id="register-password"
                    type="password"
                   placeholder="Mot de passe"
                    required
            />
            <button type="submit">S'inscrire</button>
        </form>
    </div>






    <!--  crÃ©ation ou rejoignage de salon -->
    <div id="room-section" class="hidden">
        <h2>Bonjour <span id="display-username"></span></h2>
        <form id="form-create">
            <input id="room-input" placeholder="Nom du nouveau salon" required />
            <button type="submit">CrÃ©er</button>
        </form>

        <form id="form-join">
            <select id="room-select" required>
                <option value="" disabled selected>
                    Choisissez un salon existant
                </option>
            </select>
            <button type="submit">Rejoindre</button>
        </form>
    </div>

    <!-- Ã‰tape 3 : Chat -->
    <div id="chat-section" class="hidden">
        <p>
            Vous Ãªtes dans le salon :
            <strong id="current-room-display"></strong>
        </p>
        <ul id="messages"></ul>
        <form id="form-chat">
            <input id="message-input" placeholder="Votre message..." />
            <button type="submit">Envoyer</button>
        </form>
        <button id="btn-leave">Quitter le salon</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    const authSection = document.getElementById("auth-section");
    const roomSection = document.getElementById("room-section");
    const chatSection = document.getElementById("chat-section");

    const formLogin = document.getElementById("form-login");
    const formRegister = document.getElementById("form-register");

    const roomSelect = document.getElementById("room-select");
    const roomInput = document.getElementById("room-input");
    const currentRoomDisplay = document.getElementById("current-room-display");
    const displayUsername = document.getElementById("display-username");
    const messages = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const formChat = document.getElementById("form-chat");
    const btnLeave = document.getElementById("btn-leave");

    let currentUsername = "";
    let currentRoom = "";

    // ðŸ” Authentification par token
    const token = localStorage.getItem("token");
    if (token) socket.emit("auth", token);

    socket.on("auth_success", (data) => {
        currentUsername = data.username;
        displayUsername.textContent = currentUsername;
        authSection.classList.add("hidden");
        roomSection.classList.remove("hidden");
    });

    socket.on("auth_error", () => {
        alert("Erreur d'authentification, reconnectez-vous.");
        localStorage.removeItem("token");
    });

    // Inscription
    formRegister.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("register-username").value;
        const password = document.getElementById("register-password").value;

        const res = await fetch("/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
        });

        if (res.ok) {
            alert("âœ… Inscription rÃ©ussie ! Vous pouvez vous connecter.");
        } else {
            alert("âš ï¸ Erreur : utilisateur existant.");
        }
    });

    // Connexion
    formLogin.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;

        const res = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
        });

        const data = await res.json();
        if (data.token) {
            localStorage.setItem("token", data.token);
            socket.emit("auth", data.token);
        } else {
            alert("âŒ Nom d'utilisateur ou mot de passe incorrect.");
        }
    });

    // ðŸ§© Mise Ã  jour des salons
    socket.on("update rooms", (rooms) => {
        roomSelect.innerHTML =
            '<option value="" disabled selected>Choisissez un salon</option>';
        rooms.forEach((room) => {
            const opt = document.createElement("option");
            opt.value = room;
            opt.textContent = room;
            roomSelect.appendChild(opt);
        });
    });

    // CrÃ©ation de salon
    document
        .getElementById("form-create")
        .addEventListener("submit", (e) => {
            e.preventDefault();
            const room = roomInput.value.trim();
            if (!room) return;
            currentRoom = room;
            socket.emit("create room", { username: currentUsername, room }, (ack) => {
                if (ack && ack.ok) {
                    roomSection.classList.add("hidden");
                    chatSection.classList.remove("hidden");
                    currentRoomDisplay.textContent = room;
                } else alert("Erreur de crÃ©ation de salon.");
            });
        });

    // Rejoindre un salon
    document.getElementById("form-join").addEventListener("submit", (e) => {
        e.preventDefault();
        const room = roomSelect.value;
        if (!room) return alert("SÃ©lectionnez un salon !");
        currentRoom = room;
        socket.emit("join room", { username: currentUsername, room }, (ack) => {
            if (ack && ack.ok) {
                roomSection.classList.add("hidden");
                chatSection.classList.remove("hidden");
                currentRoomDisplay.textContent = room;
            } else alert("Erreur en rejoignant le salon.");
        });
    });

    // Messages
    formChat.addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = messageInput.value.trim();
        if (!msg) return;
        socket.emit("chat message", {
            username: currentUsername,
            room: currentRoom,
            message: msg,
        });
        messageInput.value = "";
    });

    socket.on("chat message", (data) => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
    });

    socket.on("room message", (data) => {
        const li = document.createElement("li");
        li.style.fontStyle = "italic";
        li.textContent = data.message;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
    });

    // Quitter le salon
    btnLeave.addEventListener("click", () => {
        chatSection.classList.add("hidden");
        roomSection.classList.remove("hidden");
        messages.innerHTML = "";
        socket.emit("leave room", { room: currentRoom });
        currentRoom = "";
    });
</script>
</body>
</html>
